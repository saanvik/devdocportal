:javascript
  $(function(){
        $("#tree").dynatree({
        checkbox: true,
        persist: false,
        selectMode: 3,
        initAjax: { //Eventually get this back from couchdb
          url: "/facets.json",
        },
        onSelect: function(select, node) {
        // Get a list of all selected nodes, and convert to a key array:
        var selFeatureAreaKeys = $.map(node.tree.getSelectedNodes(), function(node){
          if (node.isDescendantOf(node.tree.getNodeByKey("FeatureArea"))) {
            return node.data.key;
            }
          });
        var selFeatureAreaTitles = $.map(node.tree.getSelectedNodes(), function(node){
          if (node.isDescendantOf(node.tree.getNodeByKey("FeatureArea"))) {
            $("#filterEnum").append('<a class="btn primaryBtn" id="featureAreaKey_' + node.data.key + '">' + node.data.title + '</a>');
            return node.data.title;
            }
          });        
        var selTypeKeys = $.map(node.tree.getSelectedNodes(), function(node){
          if (node.isDescendantOf(node.tree.getNodeByKey("Type"))) {
            return node.data.key;
            }
          });
        var selTypeTitles = $.map(node.tree.getSelectedNodes(), function(node){
          if (node.isDescendantOf(node.tree.getNodeByKey("Type"))) {
            $("#filterEnum").append('<a class="btn primaryBtn" id="typeKey_' + node.data.key + '">' + node.data.title + '</a>');
            return node.data.title;
            }
          });
        var selKeys = $.map(node.tree.getSelectedNodes(), function(node){
          return node.data.key;
        });
        $("#echoActive").text(selKeys.join(", "));

        // Get a list of all selected TOP nodes
        var selRootNodes = node.tree.getSelectedNodes(true);
        // ... and convert to a key array:
        var selRootKeys = $.map(selRootNodes, function(node){
          return node.data.key;
        });
        $("#clickMe").attr('href','http://localhost:4567/dbcom/en-us/search/WSDL/facet?app_area=' + ' ' + selFeatureAreaKeys.join(" ") + '&type=' + selTypeKeys.join(" "));
         },
      onDblClick: function(node, event) {
        node.toggleSelect();
      },
      onKeydown: function(node, event) {
        if( event.which == 32 ) {
          node.toggleSelect();
          return false;
        }
      }
        });
        });


%div{:class => "line",
     :id => "searchResultsLine"}
  %div{:class => "unit size1of4",
       :id => "facetDiv"}
    %div{:class=> "box callout chatty mrl"}
      %div{:class => "inner"}
        %div{:class => "hd mts"}
          %span{:class => "h4"}
            = t.facets.title
        %div{:class => "bd",
             :id => "tree"}

  %span{:id => "toggleFacets",
        :class => "ui-icon ui-icon-circle-arrow-w",
        :style => "float: left;"}
  %div{:class => "unit size3of4 last_unit",
       :id => "searchResultsDiv"}
    %div{:class => "box chatty infoBg"}
      %p{:class => "h2"}
        Search Results
      %p{:style => "padding-bottom: 10px; padding-top: 5px;"}
        %span
          = @search.total
        %span 
          = t.search_results.count
          %span <b>#{query}</b>
      %p
        %span{:class => "h3"}
          Filters:
      %p
        %a{:id => "filterEnum"}
        %span{:id => "clickMe"}
        
      %p
        %span{:id => "echoSelectionRoots"}
      %div{:class => "inner"}
        %div{:class => "box infoBg"}
          %div{:class => "data colSort"}
            %table{:class => "txtL sort_table search_results",
                   :style => "table-layout: fixed;"}
              %thead
                -# Filter search box
                -# %tr{:style =>  "background: #F2F2F2;"}
                -#   %td{:scope => "col",
                -#       :style => "width: 80%;border-width: 0;"}
                -#     %form{:id =>"filterForm",
                -#           :action => " ",
                -#           :method => "post"}
                -#       %fieldset
                -#         %div{:class=>"input",
                -#              :id => "filter"}
                -#           %input{:type=>"text",
                -#                  :id=>"f",
                -#                  :name=>"f",
                -#                  :placeholder=>t.filter.placeholder}
                -#         %input{:id => "filterButton",
                -#            :type=>"submit",
                -#            :value => "Filter",
                -#            :class => "h6 pas",
                -#            :style => "margin: 0px;"}
                  -# %td{:scope => "col",
                  -#     :style => "width: 20%;border-width: 0;"}
                %tr
                  %th{:scope => "col",
                      :class =>"sortable sorted h4",
                      :title => t.search_results.th_title,
                      :style => "width: 80%;"}
                    = t.search_results.th_title
                  %th{:scope => "col",
                      :class =>"sortable sorted h4",
                      :title => "updated",
                      :style => "min-width: 8em;"}
                    = t.search_results.th_updated
              %tbody{:class => "content"}
                - @search.each_hit_with_result do |hit, post|
                  - if (locale == 'en' or locale == 'en-us')
                    - then @localtime = Time.at(hit.result.updated_at.to_i).strftime("%b. %d, %Y")
                    - else @localtime = l Time.at(hit.result.updated_at.to_i).to_date, :full
                  - if (hit.highlight(:content).nil?)
                    - then @snippet = ""
                    - else @snippet = hit.highlight(:content).format { |word| "<span class=\"highlight\">#{word}</span>" }
                  %tr
                    %td
                      %div{:class => "search_results_title"}
                        %a{:href => "/#{root}/#{locale}/#{hit.result.topicname}"}
                          = hit.result.title
                        %br
                          = @snippet
                    %td= @localtime











